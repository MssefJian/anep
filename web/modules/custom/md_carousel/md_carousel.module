<?php

function md_carousel_theme($existing, $type, $theme, $path)
{
  return [
    'home_slide' => [
      'variables' => [
        'slide' => NULL
      ],
    ],
    'home_axis' => [
      'variables' => [
        'axis' => NULL
      ],
    ],
    'home_axis_interne' => [
      'variables' => [
        'axis' => NULL
      ],
    ],
  ];
}

/**
 * Implements hook_form_FORM_ID_alter() for node_form.
 */
function md_carousel_form_node_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  \Drupal::logger('md_carousel')->notice('Form alter hook called for form ID: @form_id', ['@form_id' => $form_id]);

  if (($form_id == 'node_announcement_form' )|| ($form_id == 'node_announcement_edit_form' )) {
    $form['field_status']['#ajax'] = [
      'callback' => 'md_carousel_status_ajax_callback',
      'wrapper' => 'edit-field-status-wrapper',
      'event' => 'change',
  ];

    $form['field_number_post']['#prefix'] = '<div id="field-number-post-wrapper">';
    $form['field_number_post']['#suffix'] = '</div>';

    _md_carousel_toggle_field_visibility($form, $form_state);
  }
}

function _md_carousel_toggle_field_visibility(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $entity = $form_state->getFormObject()->getEntity();
  \Drupal::logger('md_carousel')->notice('Entity dump: @entity', ['@entity' => print_r($entity->toArray(), TRUE)]);

  $status_entities = $entity->get('field_status')->referencedEntities();

  if (!empty($status_entities)) {
      $status_value = reset($status_entities)->getName();
  } else {
      $status_value = NULL;
  }

  $status_log = isset($status_value) ? $status_value : 'NULL or Empty';
  \Drupal::logger('md_carousel')->notice('Toggle visibility function called. Status: @status', ['@status' => $status_log]);

  $form['field_number_post']['#access'] = ($status_value === 'Ouvert');
}




function md_carousel_status_ajax_callback(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  \Drupal::logger('md_carousel')->notice('AJAX callback called.');

  _md_carousel_toggle_field_visibility($form, $form_state);

  return $form['field_number_post'];
}

